<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Realtime Text Editor (React + WS)</title>
    <style>
      :root { color-scheme: dark; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b0b0c; color: #e8eaed; }
      .wrap { max-width: 900px; margin: 0 auto; padding: 24px; }
      h1 { font-weight: 600; font-size: 20px; opacity: 0.9; }
      textarea {
        width: 100%;
        height: 420px;
        font-size: 16px;
        line-height: 1.5;
        padding: 12px 14px;
        color: #e8eaed;
        background: #15161a;
        border: 1px solid #2a2c31;
        border-radius: 8px;
        outline: none;
        resize: vertical;
      }
  .status { margin: 10px 0 4px; font-size: 12px; opacity: 0.7; }
  .toolbar { display:flex; gap:8px; margin: 10px 0 16px; }
  button { background:#2a2c31; color:#e8eaed; border:1px solid #3a3d44; border-radius:8px; padding:8px 12px; cursor:pointer; }
  button:disabled { opacity: 0.6; cursor: not-allowed; }
      .row { display: flex; gap: 8px; align-items: center; }
      code { background: #111; padding: 2px 6px; border-radius: 6px; border: 1px solid #222; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useRef, useState } = React;

      function useWebSocket(url) {
        const wsRef = useRef(null);
        const [ready, setReady] = useState(false);
        const [lastMessage, setLastMessage] = useState(null);

        useEffect(() => {
          let ws = new WebSocket(url);
          wsRef.current = ws;

          ws.onopen = () => setReady(true);
          ws.onclose = () => setReady(false);
          ws.onerror = () => setReady(false);
          ws.onmessage = (evt) => {
            try { setLastMessage(JSON.parse(evt.data)); } catch { /* ignore */ }
          };

          return () => {
            try { ws.close(); } catch {}
          };
        }, [url]);

        const sendJson = (obj) => {
          const ws = wsRef.current;
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(obj));
          }
        };

        return { ready, lastMessage, sendJson };
      }

      function EditorApp() {
        const clientIdRef = useRef(crypto.randomUUID());
        const [text, setText] = useState("");
        const [connectedAt, setConnectedAt] = useState(null);

  // Use deployed backend on Render
  const wsUrl = 'wss://codora-vk5z.onrender.com/ws/editor/';
  const { ready, lastMessage, sendJson } = useWebSocket(wsUrl);
  const [saveState, setSaveState] = useState('idle'); // idle | saving | ok | error
  const [saveMsg, setSaveMsg] = useState('');

        // Seed initial content when server sends it or when others edit
        useEffect(() => {
          if (!lastMessage) return;
          if (lastMessage.type === 'edit') {
            // Only update local state if content differs to avoid cursor jumps when we are the sender
            setText(prev => (prev !== lastMessage.content ? lastMessage.content : prev));
          }
          if (lastMessage.type === 'saved') {
            setSaveState(lastMessage.ok ? 'ok' : 'error');
            setSaveMsg(lastMessage.ok ? `Saved to ${lastMessage.path}` : `Error: ${lastMessage.error}`);
            // auto clear status after short delay
            setTimeout(() => setSaveState('idle'), 2000);
          }
        }, [lastMessage]);

        useEffect(() => {
          if (ready) setConnectedAt(new Date());
        }, [ready]);

        const onChange = (e) => {
          const value = e.target.value;
          setText(value); // Instant local update, no reload
          sendJson({ type: 'edit', content: value, clientId: clientIdRef.current });
        };

        const onSave = () => {
          setSaveState('saving');
          setSaveMsg('Saving...');
          sendJson({ type: 'save', content: text, clientId: clientIdRef.current });
        };

        return (
          <div className="wrap">
            <h1>Realtime Text Editor (React + WebSocket)</h1>
            <div className="row status">
              <div>WS: <strong style={{color: ready ? '#59d185' : '#ff6b6b'}}>{ready ? 'connected' : 'disconnected'}</strong></div>
              <div>• clientId: <code>{clientIdRef.current}</code></div>
              {connectedAt && <div>• since: <code>{connectedAt.toLocaleTimeString()}</code></div>}
            </div>
            <div className="toolbar">
              <button onClick={onSave} disabled={!ready || saveState === 'saving'}>
                {saveState === 'saving' ? 'Saving…' : 'Save to server'}
              </button>
              <div className="status">{saveMsg}</div>
            </div>
            <textarea value={text} onChange={onChange} spellCheck={false} placeholder="Start typing... This page won't reload." />
            <div className="status">Open this file in two browser windows to simulate two users.</div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<EditorApp />);
    </script>
  </body>
  </html>
